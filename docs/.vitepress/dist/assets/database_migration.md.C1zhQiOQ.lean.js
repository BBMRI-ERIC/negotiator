import{_ as a,c as t,a3 as i,o}from"./chunks/framework.D6X87co3.js";const p=JSON.parse('{"title":"Database creation and updates management","description":"","frontmatter":{},"headers":[],"relativePath":"database_migration.md","filePath":"database_migration.md","lastUpdated":1751450357000}'),n={name:"database_migration.md"};function r(s,e,d,h,l,c){return o(),t("div",null,e[0]||(e[0]=[i('<h1 id="database-creation-and-updates-management" tabindex="-1">Database creation and updates management <a class="header-anchor" href="#database-creation-and-updates-management" aria-label="Permalink to &quot;Database creation and updates management&quot;">​</a></h1><p>To handle database creation and updates the Negotiator uses the <a href="https://documentation.red-gate.com/flyway" target="_blank" rel="noreferrer">Flyway</a> tool. Flyway keeps track of the changes to the Database schema in several migration scripts, each one having a version number. Whenever the database is changed, the corresponding migration script must be created and added in the correct path of the project.<br> When the database is created, Flyway creates a table to store the current version of the schema deployed. When a new version of the Negotiator, containing changes to the DB, is deployed, Flyway applies all the missing migration scripts and updates its internal table.</p><h2 id="migration-type" tabindex="-1">Migration type <a class="header-anchor" href="#migration-type" aria-label="Permalink to &quot;Migration type&quot;">​</a></h2><p>Flyway refers to changes to the database as migrations. There are two kind of migrations: versioned and repeatable. Versioned migrations are applied only once for a database while repeatable are applied each time there is a change in the script. To read more about migrations see Flyway <a href="https://documentation.red-gate.com/fd/migrations-184127470.html" target="_blank" rel="noreferrer">documentation</a></p><p>A type of migration used in the Negotiator is the baseline migration. Initially, Flyway was not adopted, therefore, old instances of the Negotiator didn&#39;t have the Flyway table. In order to integrate Flyway with the databases created with those versions, a baseline migration with schema of the database till that version has been created. This tells Flyway that the db already present is the baseline database and it needs to apply only the other migrations.</p><h2 id="migration-file-naming" tabindex="-1">Migration file naming <a class="header-anchor" href="#migration-file-naming" aria-label="Permalink to &quot;Migration file naming&quot;">​</a></h2><p>The migrations file needs to follow the naming schema <code>&lt;Type&gt;_&lt;Version&gt;__&lt;Description&gt;.sql</code>.</p><ul><li>Type is the type of migration (V: versioned, U: Undo, R: Repeatable, B: Baseline)</li><li>Version: the version of the migration with major and minor release (e.g., 2.1). This is not needed for repeatable</li><li>Description: something to understand what the migration does</li></ul><h2 id="data" tabindex="-1">Data <a class="header-anchor" href="#data" aria-label="Permalink to &quot;Data&quot;">​</a></h2><p>Data are loaded using repeatable migrations. For example, if the Negotiator needs to be initialized with some data (e.g., default access criteria), repeatable migrations should be created.<br> Since repeatable migrations are repeated each time they change (i.e., when the checksum changes), when created for production, it is important to write them checking for data already present. By default, the repeatable migrations are expected to be in the <code>/app/data</code> path.</p><h2 id="paths" tabindex="-1">Paths <a class="header-anchor" href="#paths" aria-label="Permalink to &quot;Paths&quot;">​</a></h2><p>The migrations are in <code>resources/db</code> path. The subdirectory <code>migration</code> contains the schema for the two DBMS used in the negotiator. The <code>dev</code> and <code>test</code> subdirectories contains data (i.e., repeatable migrations) used for development and for tests.</p><h2 id="creation-of-a-new-migration" tabindex="-1">Creation of a new migration <a class="header-anchor" href="#creation-of-a-new-migration" aria-label="Permalink to &quot;Creation of a new migration&quot;">​</a></h2><p>Whenever a change to the database (i.e., to the JPA entities) is needed, a new migration must be added. The migration should provide also updates for old data if necessary. For example, if a new not null column is added to a table, the migration should also provide update stetements for old records. Intellij Ultimate Edition provides a <a href="https://plugins.jetbrains.com/plugin/8597-flyway-migration-creation" target="_blank" rel="noreferrer">plugin</a> to automatically generate the migrations</p>',14)]))}const g=a(n,[["render",r]]);export{p as __pageData,g as default};
